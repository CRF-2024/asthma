<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asthma Tracker</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-success {
            animation: pulseSuccess 0.6s ease-out;
        }
        @keyframes pulseSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-full">
  <div class="max-w-md mx-auto bg-white min-h-full shadow-lg"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-green-600 text-white p-4 sticky top-0 z-10">
    <h1 id="app-title" class="text-xl font-bold text-center">My Asthma Tracker</h1>
    <p id="welcome-message" class="text-blue-100 text-center text-sm mt-1">Track your asthma daily</p>
   </header><!-- Navigation -->
   <nav class="bg-white border-b border-gray-200 sticky top-16 z-10">
    <div class="flex"><button id="nav-log" class="flex-1 py-3 px-4 text-center font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50"> üìù Log Entry </button> <button id="nav-history" class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-blue-600"> üìä History </button>
    </div>
   </nav><!-- Main Content -->
   <main class="p-4 pb-20"><!-- Log Entry Section -->
    <section id="log-section" class="space-y-4">
     <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
      <h2 class="text-lg font-semibold text-blue-800 mb-3">üìù New Entry</h2><!-- Entry Type Selection -->
      <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Entry Type</label>
       <div class="grid grid-cols-3 gap-2"><button id="type-symptom" class="entry-type-btn bg-red-100 text-red-700 border border-red-300 rounded-lg py-2 px-3 text-sm font-medium hover:bg-red-200"> ü´Å Symptoms </button> <button id="type-medication" class="entry-type-btn bg-green-100 text-green-700 border border-green-300 rounded-lg py-2 px-3 text-sm font-medium hover:bg-green-200"> üíä Medication </button> <button id="type-peak-flow" class="entry-type-btn bg-blue-100 text-blue-700 border border-blue-300 rounded-lg py-2 px-3 text-sm font-medium hover:bg-blue-200"> üìà Peak Flow </button>
       </div>
      </div><!-- Entry Form -->
      <form id="entry-form" class="space-y-4">
       <div><label for="entry-value" class="block text-sm font-medium text-gray-700 mb-1"> <span id="value-label">Severity (1-10)</span> </label> <input type="text" id="entry-value" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter value">
       </div>
       <div><label for="entry-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label> <textarea id="entry-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Any additional notes..."></textarea>
       </div><button type="submit" id="save-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"> Save Entry </button>
      </form>
     </div><!-- Quick Stats -->
     <div class="bg-green-50 rounded-lg p-4 border border-green-200">
      <h3 class="text-lg font-semibold text-green-800 mb-3">üìä Today's Summary</h3>
      <div class="grid grid-cols-3 gap-3 text-center">
       <div class="bg-white rounded-lg p-3 border border-green-200">
        <div id="today-symptoms" class="text-2xl font-bold text-red-600">
         0
        </div>
        <div class="text-xs text-gray-600">
         Symptoms
        </div>
       </div>
       <div class="bg-white rounded-lg p-3 border border-green-200">
        <div id="today-medications" class="text-2xl font-bold text-green-600">
         0
        </div>
        <div class="text-xs text-gray-600">
         Medications
        </div>
       </div>
       <div class="bg-white rounded-lg p-3 border border-green-200">
        <div id="today-peak-flows" class="text-2xl font-bold text-blue-600">
         0
        </div>
        <div class="text-xs text-gray-600">
         Peak Flows
        </div>
       </div>
      </div>
     </div>
    </section><!-- History Section -->
    <section id="history-section" class="hidden space-y-4">
     <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">üìä Entry History</h2>
      <div id="entries-list" class="space-y-3">
       <div class="text-center text-gray-500 py-8">
        <div class="text-4xl mb-2">
         üìã
        </div>
        <p>No entries yet. Start tracking your asthma!</p>
       </div>
      </div>
     </div>
    </section>
   </main><!-- Success Toast -->
   <div id="success-toast" class="fixed bottom-4 left-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-full transition-transform duration-300 z-50">
    <div class="flex items-center"><span class="text-lg mr-2">‚úÖ</span> <span>Entry saved successfully!</span>
    </div>
   </div><!-- Error Toast -->
   <div id="error-toast" class="fixed bottom-4 left-4 right-4 bg-red-600 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-full transition-transform duration-300 z-50">
    <div class="flex items-center"><span class="text-lg mr-2">‚ùå</span> <span id="error-message">Something went wrong. Please try again.</span>
    </div>
   </div>
  </div>
<script>
    // Configuration
    const defaultConfig = {
        app_title: "My Asthma Tracker",
        welcome_message: "Track your asthma daily",
        primary_color: "#2563eb", // Default blue
        secondary_color: "#16a34a", // Default green
        background_color: "#f8fafc",
        font_family: "system-ui",
        font_size: 16
    };

    // Global state
    let currentEntryType = 'symptom';
    let allEntries = [];
    let recordCount = 0;
    let currentConfig = { ...defaultConfig }; // Store current config globally

    // Data handler for SDK
    const dataHandler = {
        onDataChanged(data) {
            allEntries = data || [];
            recordCount = allEntries.length;
            updateTodayStats();
            renderEntriesHistory();
        }
    };

    // Initialize SDKs
    async function initializeApp() {
        try {
            // Initialize Data SDK
            // This assumes the window.dataSdk is available in the execution environment
            const initResult = await (window.dataSdk?.init(dataHandler) || { isOk: true }); 
            if (!initResult.isOk) {
                console.error("Failed to initialize data SDK");
                showError("Failed to initialize app storage");
                return;
            }

            // Initialize Element SDK
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    render,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            } else {
                // Initial render if elementSdk isn't available (e.g., local testing)
                render(defaultConfig);
            }

            setupEventListeners();
            updateEntryTypeUI();
            // Ensure initial section is correct on load
            showSection('log', false);
        } catch (error) {
            console.error("Initialization error:", error);
            showError("Failed to initialize app");
        }
    }

    // Render function for Element SDK
    async function render(config) {
        currentConfig = { ...defaultConfig, ...config }; // Update global config
        const appTitle = document.getElementById('app-title');
        const welcomeMessage = document.getElementById('welcome-message');

        if (appTitle) {
            appTitle.textContent = currentConfig.app_title;
        }
        if (welcomeMessage) {
            welcomeMessage.textContent = currentConfig.welcome_message;
        }

        // Apply colors
        const primaryColor = currentConfig.primary_color;
        const secondaryColor = currentConfig.secondary_color;
        const fontSize = currentConfig.font_size;
        const fontFamily = currentConfig.font_family;

        // Apply font
        document.body.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
        document.body.style.fontSize = `${fontSize}px`;

        // Apply colors to header
        const header = document.querySelector('header');
        if (header) {
            header.style.background = `linear-gradient(to right, ${primaryColor}, ${secondaryColor})`;
        }

        // Apply colors to save button
        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) {
            saveBtn.style.backgroundColor = primaryColor;
            // Fix: Override Tailwind's blue ring with dynamic color
            saveBtn.classList.remove('focus:ring-blue-500');
            saveBtn.style.boxShadow = `0 0 0 2px ${primaryColor}, 0 0 #0000 inset`; // Apply ring for focus/active state
        }
        
        // Fix: Update navigation styles with the new primary color
        const currentNav = document.querySelector('.nav-active');
        updateNavStyles(currentNav ? (currentNav.id === 'nav-log' ? 'log' : 'history') : 'log');


        // Fix: Update input field focus ring color
        document.querySelectorAll('#entry-form input[type="text"], #entry-form textarea').forEach(input => {
            // Remove existing Tailwind classes for focus ring
            input.classList.remove('focus:ring-blue-500', 'focus:border-blue-500');
            
            // Re-apply dynamic focus styles (better than adding/removing listeners repeatedly)
            input.style.setProperty('--tw-ring-color', primaryColor); // Set custom CSS variable
            input.style.setProperty('--tw-ring-offset-color', 'white'); // Assuming white background
            input.style.transition = 'all 0.15s ease-in-out';
            input.style.outline = 'none';
            
            // Use focus events to apply the shadow effect
            input.onfocus = () => {
                input.style.borderColor = primaryColor;
                input.style.boxShadow = `0 0 0 3px ${primaryColor}40`; // Light shadow/ring effect
            };
            input.onblur = () => {
                input.style.borderColor = '#d1d5db'; // Default gray border
                input.style.boxShadow = 'none';
            };
        });
        
        // Fix: Ensure entry type UI updates to show correct ring color for Peak Flow
        updateEntryTypeUI();
    }

    // Capabilities mapping
    function mapToCapabilities(config) {
        return {
            recolorables: [
                {
                    get: () => config.primary_color || defaultConfig.primary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    }
                },
                {
                    get: () => config.secondary_color || defaultConfig.secondary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ secondary_color: value });
                        }
                    }
                }
            ],
            borderables: [],
            fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                    if (window.elementSdk) {
                        window.elementSdk.setConfig({ font_family: value });
                    }
                }
            },
            fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                    if (window.elementSdk) {
                        window.elementSdk.setConfig({ font_size: value });
                    }
                }
            }
        };
    }

    // Edit panel values mapping
    function mapToEditPanelValues(config) {
        return new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
        ]);
    }

    // Event listeners
    function setupEventListeners() {
        // Navigation
        document.getElementById('nav-log').addEventListener('click', () => showSection('log', true));
        document.getElementById('nav-history').addEventListener('click', () => showSection('history', true));

        // Entry type buttons
        document.getElementById('type-symptom').addEventListener('click', () => setEntryType('symptom'));
        document.getElementById('type-medication').addEventListener('click', () => setEntryType('medication'));
        document.getElementById('type-peak-flow').addEventListener('click', () => setEntryType('peak-flow'));

        // Form submission
        document.getElementById('entry-form').addEventListener('submit', handleFormSubmit);
    }

    // Helper to update navigation button styles
    function updateNavStyles(section) {
        const navLog = document.getElementById('nav-log');
        const navHistory = document.getElementById('nav-history');
        const primaryColor = currentConfig.primary_color;

        // Fix: Clear previous active classes/styles
        [navLog, navHistory].forEach(btn => {
            btn.classList.remove('nav-active', 'text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
            btn.classList.add('text-gray-500');
            btn.style.borderColor = '';
            btn.style.color = '';
        });

        const activeBtn = section === 'log' ? navLog : navHistory;
        
        // Fix: Apply active state and dynamic colors
        activeBtn.classList.add('nav-active', 'border-b-2', 'bg-blue-50');
        activeBtn.classList.remove('text-gray-500');
        activeBtn.style.borderColor = primaryColor;
        activeBtn.style.color = primaryColor;
    }

    // Navigation
    function showSection(section, animate = true) {
        const logSection = document.getElementById('log-section');
        const historySection = document.getElementById('history-section');
        
        if (section === 'log') {
            logSection.classList.remove('hidden');
            historySection.classList.add('hidden');
        } else {
            logSection.classList.add('hidden');
            historySection.classList.remove('hidden');
        }

        if (animate) {
            const activeSection = section === 'log' ? logSection : historySection;
            activeSection.classList.add('fade-in');
            setTimeout(() => activeSection.classList.remove('fade-in'), 300);
        }
        
        updateNavStyles(section);
    }

    // Entry type management
    function setEntryType(type) {
        currentEntryType = type;
        updateEntryTypeUI();
    }

    function updateEntryTypeUI() {
        const buttons = document.querySelectorAll('.entry-type-btn');
        const valueLabel = document.getElementById('value-label');
        const valueInput = document.getElementById('entry-value');
        const primaryColor = currentConfig.primary_color; // Use primary color for ring on peak-flow

        buttons.forEach(btn => {
            // Fix: Clean up all ring classes and custom shadow
            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-red-500', 'ring-green-500', 'ring-blue-500');
            btn.style.boxShadow = ''; 
        });

        let selectedBtn, label, placeholder;
        
        switch(currentEntryType) {
            case 'symptom':
                selectedBtn = document.getElementById('type-symptom');
                label = 'Severity (1-10)';
                placeholder = 'Rate from 1 (mild) to 10 (severe)';
                break;
            case 'medication':
                selectedBtn = document.getElementById('type-medication');
                label = 'Medication Name';
                placeholder = 'e.g., Albuterol, Inhaler';
                break;
            case 'peak-flow':
                selectedBtn = document.getElementById('type-peak-flow');
                label = 'Peak Flow (L/min)';
                placeholder = 'e.g., 450';
                break;
        }

        if (selectedBtn) {
            selectedBtn.classList.add('ring-2', 'ring-offset-2');
            if (currentEntryType === 'symptom') selectedBtn.classList.add('ring-red-500');
            else if (currentEntryType === 'medication') selectedBtn.classList.add('ring-green-500');
            else {
                 // Fix: Apply dynamic primary color for Peak Flow ring
                 selectedBtn.style.boxShadow = `0 0 0 2px ${primaryColor}`; 
            }
        }

        valueLabel.textContent = label;
        valueInput.placeholder = placeholder;
    }

    // Form handling
    async function handleFormSubmit(e) {
        e.preventDefault();

        if (recordCount >= 999) {
            showError("Maximum limit of 999 entries reached. Please delete some entries first.");
            return;
        }

        const valueInput = document.getElementById('entry-value');
        const notesInput = document.getElementById('entry-notes');
        const saveBtn = document.getElementById('save-btn');

        const value = valueInput.value.trim();
        if (!value) {
            showError("Please enter a value");
            return;
        }

        // Fix: Add basic input validation
        if (currentEntryType === 'symptom') {
            const severity = parseInt(value, 10);
            if (isNaN(severity) || severity < 1 || severity > 10) {
                showError("Severity must be a number between 1 and 10.");
                return;
            }
        } else if (currentEntryType === 'peak-flow') {
            const peakFlow = parseInt(value, 10);
            if (isNaN(peakFlow) || peakFlow <= 0 || peakFlow > 850) { // Max peak flow is around 850L/min
                showError("Peak Flow must be a positive number (up to ~850 L/min).");
                return;
            }
        }


        // Show loading state
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            const now = new Date();
            const entry = {
                // Fix: Generate a more reliable, unique ID
                id: `entry_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                type: currentEntryType,
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substring(0, 5),
                value: value,
                notes: notesInput.value.trim()
            };

            // Use optional chaining in case dataSdk isn't fully initialized
            const result = await (window.dataSdk?.create(entry) || { isOk: true });

            if (result.isOk) {
                // Reset form
                valueInput.value = '';
                notesInput.value = '';
                showSuccess();
            } else {
                showError("Failed to save entry. Please try again.");
            }
        } catch (error) {
            console.error("Save error:", error);
            showError("Failed to save entry. Please try again.");
        } finally {
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Entry';
        }
    }

    // Statistics
    function updateTodayStats() {
        const today = new Date().toISOString().split('T')[0];
        const todayEntries = allEntries.filter(entry => entry.date === today);

        const symptoms = todayEntries.filter(entry => entry.type === 'symptom').length;
        const medications = todayEntries.filter(entry => entry.type === 'medication').length;
        const peakFlows = todayEntries.filter(entry => entry.type === 'peak-flow').length;

        document.getElementById('today-symptoms').textContent = symptoms;
        document.getElementById('today-medications').textContent = medications;
        document.getElementById('today-peak-flows').textContent = peakFlows;
    }

    // History rendering
    function renderEntriesHistory() {
        const entriesList = document.getElementById('entries-list');
        
        if (allEntries.length === 0) {
            entriesList.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">üìã</div>
                    <p>No entries yet. Start tracking your asthma!</p>
                </div>
            `;
            return;
        }

        // Fix: Sort entries by date and time (newest first) using robust parsing
        const sortedEntries = [...allEntries].sort((a, b) => {
            const dateA = new Date(`${a.date}T${a.time}:00Z`); // Append :00Z for UTC interpretation
            const dateB = new Date(`${b.date}T${b.time}:00Z`);
            return dateB - dateA;
        });

        entriesList.innerHTML = sortedEntries.map(entry => {
            const typeConfig = getEntryTypeConfig(entry.type);
            return `
                <div class="bg-white rounded-lg p-3 border border-gray-200 fade-in">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-1">
                                <span class="text-lg mr-2">${typeConfig.icon}</span>
                                <span class="font-medium ${typeConfig.color}">${typeConfig.label}</span>
                                <span class="ml-auto text-sm text-gray-500">${entry.date} ${entry.time}</span>
                            </div>
                            <div class="text-sm text-gray-700 mb-1">
                                <strong>${typeConfig.valueLabel}:</strong> ${entry.value}
                            </div>
                            ${entry.notes ? `<div class="text-sm text-gray-600">${entry.notes}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getEntryTypeConfig(type) {
        switch(type) {
            case 'symptom':
                return {
                    icon: 'ü´Å',
                    label: 'Symptoms',
                    color: 'text-red-600',
                    valueLabel: 'Severity'
                };
            case 'medication':
                return {
                    icon: 'üíä',
                    label: 'Medication',
                    color: 'text-green-600',
                    valueLabel: 'Medication'
                };
            case 'peak-flow':
                return {
                    icon: 'üìà',
                    label: 'Peak Flow',
                    color: 'text-blue-600',
                    valueLabel: 'Reading'
                };
            default:
                return {
                    icon: 'üìù',
                    label: 'Entry',
                    color: 'text-gray-600',
                    valueLabel: 'Value'
                };
        }
    }

    // Toast notifications
    function showSuccess() {
        const toast = document.getElementById('success-toast');
        toast.classList.add('pulse-success');
        toast.classList.remove('translate-y-full');
        setTimeout(() => {
            toast.classList.add('translate-y-full');
            toast.classList.remove('pulse-success');
        }, 3000);
    }

    function showError(message) {
        const toast = document.getElementById('error-toast');
        const messageEl = document.getElementById('error-message');
        messageEl.textContent = message;
        toast.classList.remove('translate-y-full');
        setTimeout(() => {
            toast.classList.add('translate-y-full');
        }, 4000);
    }

    // Initialize app when page loads
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>      
 
</html>
